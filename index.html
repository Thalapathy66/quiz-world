<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trivia Clash Arena</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React Core -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Google Fonts -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700;900&display=swap');
        body { font-family: 'Outfit', sans-serif; }
        
        /* Custom Animations */
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }
        .animate-float { animation: float 3s ease-in-out infinite; }
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
    </style>
</head>
<body class="bg-slate-950 text-white overflow-hidden">

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- ICONS ---
        const Icons = {
            Trophy: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></svg>,
            Play: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill={props.fill || "none"} stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="5 3 19 12 5 21 5 3"/></svg>,
            User: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
            Users: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M22 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>,
            RefreshCw: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"/><path d="M21 3v5h-5"/><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"/><path d="M8 16H3v5"/></svg>,
            Award: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="8" r="6"/><path d="M15.477 12.89 17 22l-5-3-5 3 1.523-9.11"/></svg>,
            Zap: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill={props.fill || "none"} stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>,
            Loader2: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>,
            Ball: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20"/><path d="M2 12h20"/></svg>,
            Dna: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M2 15c6.667-6 13.333 0 20-6"/><path d="M9 22c1.798-1.998 2.518-3.995 2.807-5.993"/><path d="M15 2c-1.798 1.998-2.518 3.995-2.807 5.993"/><path d="M17 12c-5.667 4-11.333-2-17 4"/><path d="M17 12c4.762-1.808 9.076-4.603 12-8"/><path d="M7 12c-4.762 1.808-9.076 4.603-12 8"/></svg>,
            Calculator: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="16" height="20" x="4" y="2" rx="2"/><line x1="8" x2="16" y1="6" y2="6"/><line x1="16" x2="16" y1="14" y2="18"/><path d="M16 10h.01"/><path d="M12 10h.01"/><path d="M8 10h.01"/><path d="M12 14h.01"/><path d="M8 14h.01"/><path d="M12 18h.01"/><path d="M8 18h.01"/></svg>,
            Globe: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20"/><path d="M2 12h20"/></svg>,
            Atom: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="1"/><path d="M20.2 20.2c2.04-2.03.02-7.36-4.5-11.9-4.54-4.52-9.87-6.54-11.9-4.5-2.04 2.03-.02 7.36 4.5 11.9 4.54 4.52 9.87 6.54 11.9 4.5Z"/><path d="M15.7 15.7c4.52-4.54 6.54-9.87 4.5-11.9-2.03-2.04-7.36-.02-11.9 4.5-4.52 4.54-6.54 9.87-4.5 11.9 2.03 2.04 7.36.02 11.9-4.5Z"/></svg>,
            Settings: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.09a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3"/></svg>,
            Key: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m21 2-2 2m-7.6 7.6a6.5 6.5 0 1 1 5.3 5.3L3 21v-3.75L7.75 14l1.5-1.5 2.25 2.25Z"/></svg>,
            Check: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M20 6 9 17l-5-5"/></svg>,
            Clock: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
        };

        // --- CATEGORIES ---
        const CATEGORIES = [
            { id: 'cricket', name: 'Cricket', icon: Icons.Trophy, color: 'from-green-500 to-emerald-700' },
            { id: 'football', name: 'Football', icon: Icons.Ball, color: 'from-blue-500 to-indigo-700' },
            { id: 'math', name: 'Math', icon: Icons.Calculator, color: 'from-red-500 to-rose-700' },
            { id: 'science', name: 'Science', icon: Icons.Atom, color: 'from-purple-500 to-violet-700' },
            { id: 'biology', name: 'Biology', icon: Icons.Dna, color: 'from-teal-400 to-teal-600' },
            { id: 'gk', name: 'General GK', icon: Icons.Globe, color: 'from-yellow-400 to-orange-600' }
        ];

        // --- EXTENDED OFFLINE BACKUPS ---
        const FALLBACKS = {
            cricket: [
                { q: "Who won the 2011 Cricket World Cup?", options: ["Sri Lanka", "India", "Australia", "Pakistan"], ans: 1 },
                { q: "What is the maximum overs in T20?", options: ["50", "20", "10", "100"], ans: 1 },
                { q: "Which team has never won the IPL?", options: ["CSK", "MI", "RCB", "KKR"], ans: 2 },
                { q: "Who is known as the God of Cricket?", options: ["Virat Kohli", "Sachin Tendulkar", "Don Bradman", "Rohit Sharma"], ans: 1 },
                { q: "How many balls in one over?", options: ["4", "5", "6", "8"], ans: 2 },
                { q: "Where is Eden Gardens located?", options: ["Mumbai", "Delhi", "Kolkata", "Chennai"], ans: 2 }
            ],
            football: [
                { q: "Who won the 2022 FIFA World Cup?", options: ["France", "Argentina", "Brazil", "Germany"], ans: 1 },
                { q: "Which player is known as CR7?", options: ["Messi", "Ronaldo", "Neymar", "Mbappe"], ans: 1 },
                { q: "Which country is home to the Premier League?", options: ["Spain", "Italy", "England", "Germany"], ans: 2 },
                { q: "How long is a standard football match?", options: ["90 min", "60 min", "100 min", "45 min"], ans: 0 },
                { q: "Which club does Messi play for (2024)?", options: ["Barcelona", "PSG", "Inter Miami", "Al Nassr"], ans: 2 }
            ],
            math: [
                { q: "What is the value of Pi (approx)?", options: ["3.14", "2.14", "4.14", "3.41"], ans: 0 },
                { q: "Square root of 144?", options: ["10", "11", "12", "14"], ans: 2 },
                { q: "What is 7 x 8?", options: ["54", "56", "64", "48"], ans: 1 },
                { q: "What is 15 + 25?", options: ["30", "40", "35", "45"], ans: 1 },
                { q: "Solve: 100 / 4", options: ["20", "25", "24", "10"], ans: 1 }
            ],
            default: [
                { q: "Which planet is closest to the Sun?", options: ["Venus", "Mars", "Mercury", "Earth"], ans: 2 },
                { q: "H2O is the formula for?", options: ["Gold", "Silver", "Water", "Oxygen"], ans: 2 },
                { q: "Capital of Japan?", options: ["Seoul", "Beijing", "Tokyo", "Bangkok"], ans: 2 },
                { q: "How many legs does a spider have?", options: ["6", "8", "4", "10"], ans: 1 }
            ]
        };

        function App() {
            // States: intro -> api-setup -> categories -> num-players -> setup -> loading -> playing -> transition -> result
            const [gameState, setGameState] = useState('intro'); 
            const [category, setCategory] = useState(CATEGORIES[0]);
            
            // Settings State
            const [userApiKey, setUserApiKey] = useState(() => localStorage.getItem('gemini_api_key') || "");
            
            // Player Management
            const [numPlayers, setNumPlayers] = useState(2);
            const [playerData, setPlayerData] = useState([]); // [{ name: "Player 1", score: 0, misses: 0 }]
            const [currentPlayerIndex, setCurrentPlayerIndex] = useState(0);
            
            const [currentTurn, setCurrentTurn] = useState(1); // Not used as much in multi-player, using currentPlayerIndex logic
            const [rounds, setRounds] = useState(0);
            
            const [gameQuestions, setGameQuestions] = useState([]);
            const [currentQ, setCurrentQ] = useState(null);
            const [feedback, setFeedback] = useState(null);
            
            // --- TIMER STATE ---
            const [timeLeft, setTimeLeft] = useState(15);
            const [maxTime, setMaxTime] = useState(15);
            
            const TOTAL_ROUNDS = 6;
            const TOTAL_QUESTIONS_NEEDED = 6 * 5; // Enough for max players

            // --- SAVE KEY ---
            const saveApiKey = (key) => {
                setUserApiKey(key);
                localStorage.setItem('gemini_api_key', key);
            };

            // --- HELPERS ---
            const getTerm = (type) => {
                if (category.id === 'cricket') {
                    if (type === 'score') return 'Runs';
                    if (type === 'miss') return 'Wickets';
                    if (type === 'round') return 'Ball';
                    if (type === 'unit') return '';
                } else {
                    if (type === 'score') return 'Points';
                    if (type === 'miss') return 'Misses';
                    if (type === 'round') return 'Q';
                    if (type === 'unit') return 'pts';
                }
            };

            const shuffleArray = (array) => {
                const arr = [...array];
                for (let i = arr.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [arr[i], arr[j]] = [arr[j], arr[i]];
                }
                return arr;
            };

            const handlePlayerCount = (count) => {
                setNumPlayers(count);
                // Initialize placeholder data
                const initialPlayers = Array(count).fill(0).map((_, i) => ({
                    name: `Player ${i+1}`,
                    score: 0,
                    misses: 0
                }));
                setPlayerData(initialPlayers);
                setGameState('setup');
            };

            const updatePlayerName = (index, name) => {
                const newPlayers = [...playerData];
                newPlayers[index].name = name;
                setPlayerData(newPlayers);
            };

            const fetchQuestions = async () => {
                setGameState('loading');
                
                // We need more questions for more players to avoid repeats if we want unique ones, 
                // OR we can share the same pool but randomize access. 
                // Simple approach: Generate 12 (standard) or attempt 20+ for multiplayer.
                // Free API might trunc at output token limit. Let's ask for 15, reuse/shuffle if run out.
                
                const prompt = `Generate 15 unique, fun, multiple-choice quiz questions about ${category.name}. 
                Difficulty: Medium. 
                Format: JSON object with key "questions" (array of objects). 
                Each object: "q" (string), "options" (array of 4 strings), "ans" (int 0-3).`;

                const loadFallback = () => {
                    console.log("Using Fallback Questions");
                    const fallbackSet = FALLBACKS[category.id] || FALLBACKS.default;
                    let pool = shuffleArray([...fallbackSet]);
                    let filled = [];
                    // Ensure we have enough for the game
                    while(filled.length < 30) { filled = [...filled, ...pool]; }
                    setGameQuestions(filled);
                    setCurrentQ(filled[0]);
                    calculateTime(filled[0]);
                };

                const keyToUse = userApiKey.trim();

                if (!keyToUse) {
                    await new Promise(r => setTimeout(r, 1000));
                    loadFallback();
                } else {
                    try {
                        const response = await fetch(
                            `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${keyToUse}`,
                            {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({
                                    contents: [{ parts: [{ text: prompt }] }],
                                    generationConfig: { responseMimeType: "application/json" }
                                })
                            }
                        );
                        
                        if (!response.ok) throw new Error("API Error");
                        
                        const data = await response.json();
                        const parsed = JSON.parse(data.candidates[0].content.parts[0].text);
                        
                        if(parsed.questions && parsed.questions.length > 0) {
                             // Duplicate if not enough (rare edge case for 5 players)
                             let finalQ = parsed.questions;
                             while(finalQ.length < 30) { finalQ = [...finalQ, ...parsed.questions]; }
                             setGameQuestions(finalQ);
                             setCurrentQ(finalQ[0]);
                             calculateTime(finalQ[0]);
                        } else {
                            throw new Error("No questions generated");
                        }
                    } catch (e) {
                        console.error(e);
                        loadFallback();
                    }
                }

                // Reset Game Logic
                setRounds(0);
                setCurrentPlayerIndex(0);
                // Reset Scores
                setPlayerData(prev => prev.map(p => ({ ...p, score: 0, misses: 0 })));
                
                setFeedback(null);
                setGameState('playing');
            };

            const calculateTime = (questionObj) => {
                if(!questionObj) return;
                const wordCount = questionObj.q.split(' ').length;
                const calculated = Math.min(25, Math.max(10, Math.floor(10 + (wordCount * 0.5))));
                setMaxTime(calculated);
                setTimeLeft(calculated);
            };

            const handleAnswer = (idx) => {
                const isTimeout = idx === -1;
                const isCorrect = !isTimeout && idx === currentQ.ans;
                
                let score = 0;
                let text = "";
                let type = "miss";

                if (isCorrect) {
                    const rand = Math.random();
                    if (rand > 0.8) score = 6;
                    else if (rand > 0.5) score = 4;
                    else if (rand > 0.2) score = 2;
                    else score = 1;
                    text = `+${score} ${getTerm('score')}`;
                    type = "score";
                } else {
                    text = isTimeout ? "TIME UP!" : (category.id === 'cricket' ? "WICKET!" : "WRONG!");
                    type = "miss";
                }

                setFeedback({ type, text, score });

                // Update Score for Current Player
                setPlayerData(prev => {
                    const newP = [...prev];
                    const p = newP[currentPlayerIndex];
                    if (isCorrect) p.score += score;
                    else p.misses += 1;
                    return newP;
                });

                setTimeout(nextRound, 1500);
            };

            const nextRound = () => {
                setFeedback(null);
                const newRound = rounds + 1;

                // Win condition check for 2-player chase mode specifically
                if (numPlayers === 2 && currentPlayerIndex === 1) {
                     const p2 = playerData[1];
                     const p1Score = playerData[0].score;
                     if (p2.score > p1Score) {
                         setGameState('result');
                         return;
                     }
                }

                if (newRound >= TOTAL_ROUNDS) {
                    // Current player finished their over
                    if (currentPlayerIndex < numPlayers - 1) {
                        setGameState('transition');
                    } else {
                        setGameState('result');
                    }
                } else {
                    setRounds(newRound);
                    // Use a unique index calculation to ensure different questions if possible
                    const qIndex = (currentPlayerIndex * 6) + newRound; 
                    const nextQ = gameQuestions[qIndex % gameQuestions.length];
                    setCurrentQ(nextQ);
                    calculateTime(nextQ);
                }
            };
            
            const startNextPlayer = () => {
                const nextIndex = currentPlayerIndex + 1;
                setCurrentPlayerIndex(nextIndex);
                setRounds(0);
                
                const qIndex = (nextIndex * 6);
                const nextQ = gameQuestions[qIndex % gameQuestions.length];
                setCurrentQ(nextQ);
                calculateTime(nextQ);
                
                setGameState('playing');
            };

            useEffect(() => {
                if (gameState !== 'playing' || feedback !== null) return;
                
                if (timeLeft <= 0) {
                    handleAnswer(-1); 
                    return;
                }
                const timer = setInterval(() => {
                    setTimeLeft(prev => prev - 1);
                }, 1000);
                return () => clearInterval(timer);
            }, [timeLeft, gameState, feedback]);

            // --- RENDER SCREENS ---

            // 1. INTRO
            if (gameState === 'intro') {
                return (
                    <div className="min-h-screen bg-slate-900 flex flex-col items-center justify-center p-6 relative overflow-hidden">
                        <div className="absolute top-0 left-0 w-full h-full overflow-hidden z-0">
                            <div className="absolute top-[-10%] left-[-10%] w-[50%] h-[50%] rounded-full bg-purple-600/20 blur-[100px]"></div>
                            <div className="absolute bottom-[-10%] right-[-10%] w-[50%] h-[50%] rounded-full bg-blue-600/20 blur-[100px]"></div>
                        </div>

                        <div className="relative z-10 text-center animate-float">
                            <h1 className="text-7xl md:text-9xl font-black text-transparent bg-clip-text bg-gradient-to-r from-blue-400 via-purple-400 to-pink-400 mb-8 tracking-tighter drop-shadow-2xl">
                                TRIVIA<br/>CLASH
                            </h1>
                            <button onClick={() => setGameState('api-setup')} className="group relative inline-flex items-center justify-center px-12 py-5 text-lg font-bold text-white transition-all duration-200 bg-white/10 font-pj rounded-full focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-900 border border-white/20 hover:bg-white/20 hover:scale-105">
                                <span className="mr-3">Let's Goo!!</span>
                                <Icons.Zap className="w-6 h-6 text-yellow-400 group-hover:text-yellow-300 animate-pulse" fill="currentColor"/>
                            </button>
                        </div>
                    </div>
                );
            }

            // 2. API SETUP
            if (gameState === 'api-setup') {
                return (
                    <div className="min-h-screen bg-slate-950 flex flex-col items-center justify-center p-6">
                        <div className="w-full max-w-2xl glass-panel rounded-3xl p-8 relative">
                             <h2 className="text-3xl font-bold mb-6 text-center text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-green-400">Unlock Infinite Questions ðŸš€</h2>
                             
                             {/* Tutorial Section */}
                             <div className="bg-slate-900/50 p-6 rounded-xl border border-white/10 mb-8">
                                 <h3 className="font-bold text-white mb-4 flex items-center gap-2">
                                    <Icons.Key size={20} className="text-yellow-400"/> How to get a FREE Key (30s):
                                 </h3>
                                 <ol className="list-decimal list-inside space-y-3 text-sm text-white/70">
                                     <li>Go to <a href="https://aistudio.google.com/app/apikey" target="_blank" className="text-blue-400 underline hover:text-white">Google AI Studio</a>.</li>
                                     <li>Click the blue <b>"Create API key"</b> button.</li>
                                     <li>Copy the key (starts with <code className="bg-black/30 px-1 rounded text-green-400">AIzaSy...</code>).</li>
                                     <li>Paste it in the box below!</li>
                                 </ol>
                             </div>

                             <div className="mb-6">
                                <label className="block text-xs uppercase tracking-widest text-white/50 mb-2 font-bold">Paste API Key</label>
                                <div className="flex gap-2">
                                    <input 
                                        type="text" 
                                        value={userApiKey} 
                                        onChange={(e) => saveApiKey(e.target.value)} 
                                        placeholder="AIzaSy..." 
                                        className="flex-1 bg-slate-950 border border-white/20 rounded-xl p-4 text-white focus:border-blue-500 outline-none transition-all font-mono shadow-inner"
                                    />
                                </div>
                             </div>

                             <div className="flex gap-3">
                                 <button 
                                    onClick={() => setGameState('categories')} 
                                    className={`flex-1 py-4 rounded-xl font-bold text-lg shadow-lg transition-all ${userApiKey ? 'bg-gradient-to-r from-blue-600 to-blue-500 hover:scale-[1.02]' : 'bg-slate-800 text-white/30'}`}
                                 >
                                    {userApiKey ? "Save & Start Game" : "Enter Key to Start"}
                                 </button>
                                 <button 
                                    onClick={() => setGameState('categories')} 
                                    className="px-6 py-4 rounded-xl font-bold text-white/40 hover:text-white hover:bg-white/5 transition-all text-sm border border-white/5"
                                 >
                                    Skip
                                 </button>
                             </div>
                        </div>
                    </div>
                );
            }

            // 3. CATEGORIES
            if (gameState === 'categories') {
                return (
                    <div className="min-h-screen bg-slate-950 flex flex-col items-center p-6">
                        <h2 className="text-3xl font-bold mb-8 text-center text-white/90">Choose Arena</h2>
                        <div className="grid grid-cols-2 md:grid-cols-3 gap-4 max-w-4xl w-full">
                            {CATEGORIES.map(cat => (
                                <button key={cat.id} onClick={() => { setCategory(cat); setGameState('num-players'); }} className={`relative p-6 rounded-2xl border border-white/10 bg-slate-900/50 hover:bg-slate-800 transition-all group overflow-hidden text-left`}>
                                    <div className={`absolute inset-0 bg-gradient-to-br ${cat.color} opacity-0 group-hover:opacity-10 transition-opacity`}></div>
                                    <cat.icon className={`w-10 h-10 mb-4 text-white/70 group-hover:text-white group-hover:scale-110 transition-transform`} />
                                    <h3 className="text-xl font-bold">{cat.name}</h3>
                                </button>
                            ))}
                        </div>
                    </div>
                );
            }

            // 3.5 NUM PLAYERS
            if (gameState === 'num-players') {
                return (
                    <div className="min-h-screen bg-slate-950 flex flex-col items-center justify-center p-6">
                        <div className="w-full max-w-md glass-panel p-8 rounded-3xl text-center">
                            <Icons.Users className="w-16 h-16 mx-auto mb-4 text-white/80" />
                            <h2 className="text-3xl font-bold mb-6">How many players?</h2>
                            <div className="grid grid-cols-5 gap-2 mb-8">
                                {[1,2,3,4,5].map(n => (
                                    <button 
                                        key={n} 
                                        onClick={() => handlePlayerCount(n)}
                                        className="aspect-square rounded-xl bg-slate-800 border-2 border-slate-700 hover:border-blue-500 hover:bg-slate-700 font-bold text-xl transition-all"
                                    >
                                        {n}
                                    </button>
                                ))}
                            </div>
                            <button onClick={() => setGameState('categories')} className="text-white/30 hover:text-white text-sm">Back</button>
                        </div>
                    </div>
                );
            }

            // 4. SETUP PLAYERS
            if (gameState === 'setup') {
                return (
                    <div className="min-h-screen bg-slate-950 flex items-center justify-center p-6">
                         <div className="w-full max-w-md glass-panel p-8 rounded-3xl text-center relative overflow-hidden">
                             <div className={`absolute top-0 left-0 w-full h-2 bg-gradient-to-r ${category.color}`}></div>
                             <h2 className="text-3xl font-bold mb-2">{category.name} Clash</h2>
                             <p className="text-white/50 mb-6 text-sm">Enter challenger names</p>

                             <div className="space-y-3 mb-8 max-h-[40vh] overflow-y-auto no-scrollbar">
                                {playerData.map((p, i) => (
                                    <div key={i} className="bg-slate-900/50 rounded-xl p-2 border border-white/10 flex items-center">
                                        <div className="p-3 bg-white/5 rounded-lg mr-3 font-bold text-white/50 w-10">{i+1}</div>
                                        <input 
                                            type="text" 
                                            value={p.name} 
                                            onChange={e => updatePlayerName(i, e.target.value)} 
                                            className="bg-transparent w-full outline-none placeholder-white/30" 
                                            placeholder={`Player ${i+1}`}
                                        />
                                    </div>
                                ))}
                             </div>

                             <button onClick={fetchQuestions} className={`w-full py-4 rounded-xl font-bold text-lg bg-gradient-to-r ${category.color} hover:brightness-110 transition shadow-lg`}>
                                Start Match
                             </button>
                         </div>
                    </div>
                );
            }

            // 5. LOADING
            if (gameState === 'loading') {
                return (
                    <div className="min-h-screen bg-slate-950 flex flex-col items-center justify-center">
                        <Icons.Loader2 className="w-12 h-12 text-blue-500 animate-spin mb-4" />
                        <p className="text-white/70 animate-pulse">Curating {category.name} Questions...</p>
                    </div>
                );
            }

            // 6. PLAYING
            if (gameState === 'playing') {
                const currentPlayer = playerData[currentPlayerIndex];
                const target = (numPlayers === 2 && currentPlayerIndex === 1) ? playerData[0].score + 1 : null;
                const timePercent = (timeLeft / maxTime) * 100;
                
                return (
                    <div className="min-h-screen bg-slate-950 flex flex-col items-center p-4">
                        <div className="w-full max-w-lg glass-panel rounded-2xl p-6 mb-6 relative overflow-hidden">
                            <div className={`absolute top-0 right-0 p-32 bg-gradient-to-br ${category.color} opacity-20 blur-[60px] rounded-full translate-x-10 -translate-y-10`}></div>
                            <div className="flex justify-between items-end relative z-10">
                                <div>
                                    <div className="text-xs uppercase tracking-widest text-white/50 mb-1">
                                        {numPlayers > 1 ? `Player ${currentPlayerIndex + 1} of ${numPlayers}` : "Solo Run"}
                                    </div>
                                    <h2 className="text-2xl font-bold flex items-center gap-2">
                                        <Icons.User size={20} className="text-white/70"/> {currentPlayer.name}
                                    </h2>
                                    {target && <div className="text-xs text-blue-400 mt-1">Target: {target}</div>}
                                </div>
                                <div className="text-right">
                                    <div className="text-5xl font-black leading-none">
                                        {currentPlayer.score}<span className="text-2xl text-white/40">/{currentPlayer.misses}</span>
                                    </div>
                                    <div className="text-xs font-bold uppercase tracking-widest text-white/40 mt-1">
                                        {getTerm('score')} / {getTerm('miss')}
                                    </div>
                                </div>
                            </div>
                            <div className="flex gap-2 mt-6">
                                {[...Array(TOTAL_ROUNDS)].map((_, i) => (
                                    <div key={i} className={`h-1.5 flex-1 rounded-full transition-colors ${i < rounds ? `bg-white` : i === rounds ? 'bg-blue-500' : 'bg-white/10'}`}></div>
                                ))}
                            </div>
                        </div>

                        <div className="w-full max-w-lg flex-1 relative">
                            {feedback && (
                                <div className="absolute inset-0 z-50 flex items-center justify-center bg-slate-950/80 backdrop-blur-sm rounded-3xl animate-in fade-in zoom-in duration-200">
                                    <div className="text-center">
                                        <div className={`text-6xl font-black mb-2 ${feedback.type === 'score' ? 'text-green-400' : 'text-red-500'}`}>
                                            {feedback.text}
                                        </div>
                                    </div>
                                </div>
                            )}

                            <div className="bg-white text-slate-900 rounded-3xl p-6 shadow-2xl h-full flex flex-col relative overflow-hidden">
                                <div className="absolute top-0 left-0 h-1.5 bg-slate-100 w-full">
                                    <div className={`h-full transition-all duration-1000 ease-linear ${timeLeft < 5 ? 'bg-red-500' : 'bg-blue-500'}`} style={{width: `${timePercent}%`}}></div>
                                </div>
                                <div className="mb-6 mt-2">
                                    <div className="flex justify-between items-center mb-4">
                                        <span className="inline-block px-3 py-1 rounded-full bg-slate-100 text-xs font-bold uppercase tracking-widest text-slate-500">
                                            {getTerm('round')} {rounds + 1}
                                        </span>
                                        <div className={`flex items-center gap-1 font-mono font-bold ${timeLeft < 5 ? 'text-red-500 animate-pulse' : 'text-slate-400'}`}>
                                            <Icons.Clock size={14}/> {timeLeft}s
                                        </div>
                                    </div>
                                    <h3 className="text-2xl font-bold leading-tight">{currentQ?.q}</h3>
                                </div>
                                <div className="space-y-3 mt-auto">
                                    {currentQ?.options.map((opt, i) => (
                                        <button key={i} onClick={() => !feedback && handleAnswer(i)} className="w-full text-left p-4 rounded-xl border-2 border-slate-100 hover:border-blue-500 hover:bg-blue-50 transition-all font-semibold flex justify-between group">
                                            {opt}
                                            <div className="w-6 h-6 rounded-full border-2 border-slate-200 group-hover:border-blue-500"></div>
                                        </button>
                                    ))}
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            // 7. TRANSITION
            if (gameState === 'transition') {
                const prevP = playerData[currentPlayerIndex];
                const nextP = playerData[currentPlayerIndex + 1];
                
                return (
                    <div className="min-h-screen bg-slate-950 flex flex-col items-center justify-center p-6 text-center">
                        <h2 className="text-4xl font-bold mb-2">Innings Break!</h2>
                        <div className="glass-panel p-8 rounded-3xl max-w-sm w-full mb-8">
                             <div className="text-sm uppercase tracking-widest text-white/50 mb-2">{prevP.name}'s Score</div>
                             <div className="text-6xl font-black text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-green-400">
                                 {prevP.score}
                             </div>
                             {numPlayers === 2 && (
                                <div className="mt-4 p-3 bg-white/5 rounded-xl text-white/80">
                                    Target to Win: <span className="font-bold text-yellow-400">{prevP.score + 1}</span>
                                </div>
                             )}
                        </div>
                        <div className="text-white/60 mb-6">Up Next: <span className="text-white font-bold text-xl">{nextP.name}</span></div>
                        <button onClick={startNextPlayer} className="px-8 py-4 bg-white text-slate-900 rounded-full font-bold text-lg hover:scale-105 transition">
                            Start Turn
                        </button>
                    </div>
                );
            }

            // 8. RESULT
            if (gameState === 'result') {
                // Sort players by score
                const sortedPlayers = [...playerData].sort((a,b) => b.score - a.score);
                const winner = sortedPlayers[0];
                const isTie = sortedPlayers.length > 1 && sortedPlayers[0].score === sortedPlayers[1].score;

                return (
                    <div className="min-h-screen bg-slate-950 flex flex-col items-center justify-center p-6 text-center">
                         <Icons.Award className="w-24 h-24 text-yellow-400 mb-6 drop-shadow-lg" />
                         <div className="text-sm uppercase tracking-widest text-white/50 mb-2">Winner</div>
                         <h1 className="text-5xl font-black mb-8">{isTie ? "It's a Tie!" : winner.name}</h1>
                         
                         <div className="w-full max-w-md space-y-3 mb-8">
                             {sortedPlayers.map((p, i) => (
                                 <div key={i} className={`glass-panel p-4 rounded-xl flex justify-between items-center ${i === 0 ? 'border-yellow-400/50 bg-yellow-400/10' : ''}`}>
                                     <div className="flex items-center gap-3">
                                         <div className="font-bold text-white/30 w-6">#{i+1}</div>
                                         <div className="font-bold">{p.name}</div>
                                     </div>
                                     <div className="text-2xl font-bold">{p.score}</div>
                                 </div>
                             ))}
                         </div>

                         <button onClick={() => setGameState('categories')} className="flex items-center gap-2 px-8 py-4 bg-blue-600 rounded-full font-bold hover:bg-blue-500 transition">
                             <Icons.RefreshCw size={20}/> Play Again
                         </button>
                    </div>
                );
            }
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>